================================================================================
  FIX BROKEN IMAGES AND VIDEOS ON PRODUCTION SERVER
  MCC News Aggregator - https://mcc-nac.com
================================================================================

PROBLEM:
--------
Images and videos uploaded by admins appear broken in the user dashboard.
This happens because Laravel stores files in storage/app/public/ but serves 
them through public/storage/, and the symbolic link is missing.


QUICK FIX (Run on Production Server via SSH):
----------------------------------------------

Step 1: Create Symbolic Link
-----------------------------
cd /path/to/your/laravel/project
php artisan storage:link

This creates: public/storage -> storage/app/public


Step 2: Set Correct Permissions
--------------------------------
chmod -R 775 storage
chmod -R 775 bootstrap/cache
chown -R www-data:www-data storage
chown -R www-data:www-data bootstrap/cache

Note: Replace "www-data" with your web server user
Common alternatives: apache, nginx, or your cPanel username


Step 3: Update Production .env
-------------------------------
Make sure these settings are correct:

APP_URL=https://mcc-nac.com
FILESYSTEM_DISK=public
APP_ENV=production

IMPORTANT: Change APP_URL from http://127.0.0.1:8000 to your actual domain!


Step 4: Clear All Caches
-------------------------
php artisan config:clear
php artisan cache:clear
php artisan view:clear
php artisan route:clear


Step 5: Test
------------
1. Upload a diagnostic file to check your setup:
   - Upload public/storage-test.php to your server
   - Access: https://mcc-nac.com/storage-test.php
   - Follow the diagnostic results

2. Upload new content from admin panel
3. Check if images/videos display correctly in user dashboard
4. DELETE storage-test.php after testing for security!


VERIFICATION CHECKLIST:
-----------------------
[ ] Symbolic link exists: ls -la public/storage
    Should show: public/storage -> ../storage/app/public

[ ] Storage directory is writable: ls -la storage/app/public
    Should show: drwxrwxr-x (775 permissions)

[ ] Test image URL loads: https://mcc-nac.com/storage/announcement-images/test.jpg

[ ] APP_URL is correct in .env: https://mcc-nac.com (NOT localhost!)

[ ] Config cache cleared: php artisan config:clear


ALTERNATIVE SOLUTION (If Symlinks Don't Work):
-----------------------------------------------
Some shared hosting providers disable symbolic links for security.
If php artisan storage:link fails, use direct public uploads:

1. Update .env:
   FILESYSTEM_DISK=public_uploads

2. Create uploads directory:
   mkdir -p public/uploads
   chmod 775 public/uploads

3. Move existing files (if any):
   cp -r storage/app/public/* public/uploads/
   
4. Clear config:
   php artisan config:clear

5. Future uploads will go directly to public/uploads/ (no symlink needed)

Note: The filesystems.php config already has 'public_uploads' disk configured!


COMMON ISSUES & SOLUTIONS:
--------------------------

Issue 1: "Permission denied" when creating symlink
Solution: Your user needs write access to public/ directory
   sudo chown -R $USER:$USER public/

Issue 2: Symlink exists but images still broken
Solution: 
   - Check APP_URL in .env matches your domain (with https://)
   - Run: php artisan config:clear
   - Check web server has read access: chmod -R 775 storage/app/public

Issue 3: "symlink(): Function disabled for security reasons"
Solution: Your host disabled symlinks, use Alternative Solution above

Issue 4: Old images work but new ones don't
Solution: 
   - Check storage/app/public/ permissions: chmod -R 775 storage
   - Check ownership: chown -R www-data:www-data storage

Issue 5: Some images load, others don't
Solution:
   - Check individual file permissions in storage/app/public/
   - May need: find storage/app/public -type f -exec chmod 644 {} \;


HOSTING-SPECIFIC NOTES:
-----------------------

cPanel Hosting:
- Use File Manager to check if public/storage exists
- If not, use Terminal feature to run: php artisan storage:link
- Web server user is usually your cPanel username
- Permissions: 755 for directories, 644 for files

Shared Hosting (no SSH):
- Use Alternative Solution (public_uploads disk)
- Upload files via FTP to public/uploads/
- Set folder permissions to 755 via FTP client

VPS/Dedicated Server:
- Full control, use standard symlink method
- Web server user: www-data (Ubuntu/Debian) or apache (CentOS)

Cloudways/Managed Hosting:
- Usually symlinks work fine
- Use their built-in terminal/SSH access
- May need to use their specific user (e.g., master_user)


IMPORTANT SECURITY NOTES:
--------------------------
1. Never set 777 permissions (security risk)
2. Use 775 for directories, 644 for files
3. Delete storage-test.php after diagnosis
4. Ensure .env file is NOT publicly accessible
5. Keep storage/ folder outside public/ (Laravel's design)


CONTACT INFORMATION:
--------------------
If issues persist after following this guide:
1. Check Laravel logs: storage/logs/laravel.log
2. Check web server error logs
3. Run the diagnostic tool: storage-test.php
4. Check your hosting provider's documentation for Laravel deployment


================================================================================
Last Updated: 2025
MCC News Aggregator - Madridejos Community College
================================================================================
